trigger:
  - none

variables:
  group: DeploymentVariables

stages:
- stage: StreamAnalyticsJob
  jobs:
  - job: BuildStreamAnaltics
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: UseDotNet@2
        displayName:  'Use .Net 5'
        inputs:
          version: 5.x
          includePreviewVersions: true
      - task: UseDotNet@2
        displayName: 'Install .NET Core SDK'
        inputs:
          version: 5.x
          performMultiLevelLookup: true
          includePreviewVersions: true
      - task: Npm@1
        displayName: 'Install stream analytics ci/cd package'
        inputs:
          command: 'custom'
          customCommand: 'sudo install azure-streamanalytics-cicd'
          verbose: true
      - task: CmdLine@2
        displayName: 'Build stream analytics project'
        inputs:
          script: 'azure-streamanalytics-cicd build -project ./asaproj.json -outputpath $(projectRootPath)/$(outputPath)/$(deployPath)'
      - task: CopyFiles@2
        displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
        inputs:
          sourceFolder: $(system.defaultworkingdirectory)/$(outputPath)/
          contents: '**' 
          targetFolder: $(build.artifactstagingdirectory)
      - task: PublishBuildArtifacts@1
        displayName: 'Public artifact: drop'
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)' 
          artifactName: 'drop'
- stage: ResourceDeployment
  dependsOn: StreamAnalyticsJob
  jobs:
    - job: DeployResourceGroup
      pool:
        vmImage: 'ubuntu-latest'
      displayName: 'Create Resource Group and Resources'
      steps:
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: 'Create or update resource group'
        inputs:
          azureResourceManagerConnection: 'VSProSubscription'
          subscriptionId: '$(deploymentSubscription)'
          action: 'Create Or Update Resource Group'
          resourceGroupName: 'mercury-iot'
          location: 'Central US'
          templateLocation: 'URL of the file'
          csmFileLink: 'https://raw.githubusercontent.com/mhenderson442/mercury-iot/master/templates/mercury-iot-template.json'
          csmParametersFileLink: 'https://raw.githubusercontent.com/mhenderson442/mercury-iot/master/templates/mercury-iot-template.parameters.json'
          deploymentMode: 'Incremental'   